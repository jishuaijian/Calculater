var console=console||{log:function(){return!1}};function begin_to_play(){is_mobile?($(".wrap").hide(),$(".mobile_wrap").show(),init_mobile()):init_pc()}function not_yunpan_url(){0<config_xml.video.length&&!endsWith(config_xml.video,"meta.json")&&-1==config_xml.video.indexOf("http://")&&(config_xml.video=config_xml.video),config_xml.videocloud?endsWith(config_xml.videocloud,"meta.json")||(config_xml.videoSegPath="videoForSeg/yunPan/"+config_xml.videocloud+".VIDEOSEGMENTS/meta.json"):endsWith(config_xml.video,"meta.json")&&(config_xml.videoSegPath=config_xml.video,config_xml.video=""),begin_to_play()}function init_course(){var e=/http.{3,5}yunpan\.webtrn\.cn\/.+openhtmlcontent\/(.+)\/false\/(.+\/)index\.htm/.test(parent.document.location.href),t=/.*meta\.json/.test(config_xml.video);if(e&&!t){var o=RegExp.$1,i=RegExp.$2;$.ajax({type:"get",url:"http://yunpan.sdk.webtrn.cn/api/shares/info?shareid="+o,dataType:"json",success:function(e){if(200===e.statusLine){var t=e.userid,n="http://yunpan.sdk.webtrn.cn/api/play/share-video/uri?shareId="+o+"&path="+i+config_xml.video;config_xml.video="http://yunpan.sdk.webtrn.cn/api/play/mp4?path="+decodeURI(i+config_xml.video)+"&userId="+t,$.ajax({type:"get",url:n,dataType:"json",success:function(e){config_xml.videoSegPath=e.videoURL,begin_to_play()},error:function(e){not_yunpan_url()}})}else not_yunpan_url()},error:function(){not_yunpan_url()}})}else not_yunpan_url()}function init_mobile(){var e=document.getElementById("s-video");e.onerror=function(){alert("视频无法播放，请联系视频提供方")},e.oncanplay=function(){console.log("video can play")},e.src=config_xml.video,console.log("local video")}function init_pc(){$(window).resize(function(){resize_element()}),$(window).trigger("resize"),$("coursename").text(config_xml.title);var e="";"srt"==config_xml.captionType&&(e=config_xml.caption),loadVideo({element_id:"flash_player",url:config_xml.video,seg_url:config_xml.videoSegPath,play_seg:config_xml.videoSegPath&&0<config_xml.videoSegPath.length,startTime:0,subtitle_url:e,show_caption:!0,with_controls:!0})}function resize_element(){var e=$(".copyright"),t=0;e&&e.is(":visible")&&(t=e.height());$(window).width();var n=$(window).height(),o=n-$(".title").height()-t,i=4*o/3;$(".wrap").height(n),$(".wrap").width(i),$(".videomain").height(o),$(".videomain").width(i)}function ParseXML(e){this.xmlPath=e;var t=loadXML(this.xmlPath);if(!t||!t.firstChild)return null;var n=t.getElementsByTagName("properties")[0],o=n.getElementsByTagName("title");this.title=GetCheckedNodeValue(o),o=n.getElementsByTagName("creationdate"),this.creationdate=GetCheckedNodeValue(o),o=n.getElementsByTagName("totaltime"),this.totaltime=GetCheckedNodeValue(o),o=n.getElementsByTagName("video"),this.video=GetCheckedNodeValue(o),o=n.getElementsByTagName("videocloud"),this.videocloud=GetCheckedNodeValue(o),o=n.getElementsByTagName("screen"),this.screen=GetCheckedNodeValue(o),o=n.getElementsByTagName("screencloud"),this.screencloud=GetCheckedNodeValue(o),o=n.getElementsByTagName("caption"),this.caption=GetCheckedNodeValue(o),this.captionType=this.caption.substring(this.caption.length-3),o=n.getElementsByTagName("copyright"),this.copyright=GetCheckedNodeValue(o),this.video.length<=0&&0<this.screen.length&&(this.video=this.screen)}function loadXML(e){return window.XMLHttpRequest?xmlhttp=new XMLHttpRequest:xmlhttp=new ActiveXObject("Microsoft.XMLHTTP"),xmlhttp.open("GET",e,!1),xmlhttp.send(),xmlhttp.responseXML}function GetCheckedNodeValue(e,t){return null==e||0==e.length?null:null==e[0].firstChild?null:null!=e[0].firstChild.nodeValue?e[0].firstChild.nodeValue:null}function endsWith(e,t){return-1!==e.indexOf(t,e.length-t.length)}function isIE(){return/msie/.test(navigator.userAgent.toLowerCase())}function check_url(e){if(isIE()&&window.XDomainRequest){var t=new XDomainRequest;t.open("get",e.url),t.onload=function(){e.onDone()},t.onerror=function(){e.onError()},t.send()}else $.get(e.url).done(e.onDone).fail(e.onError)}function GetCoursePath(e,t){var n;t=void 0!==t?t:document.location.href;for(var o=0;o<e;o++)n=t.lastIndexOf("/"),t=t.substring(0,n);return n=t.lastIndexOf("/"),t.substring(n+1)}function loadVideo(t){console.log(t.play_seg?"playing segments video.":"playing local video.");var e=t.play_seg?t.seg_url:t.url,n=jwplayer(t.element_id).setup({file:encodeURI(e),playbackrates:[3,2,1.5,1],type:t.play_seg?"flvlist":"mp4",width:"100%",height:"100%",primary:"flash",show_audio_level:!0,controls:t.with_controls,tracks:[{file:t.subtitle_url,kind:"captions",default:!0}],captions:{color:"#FFFFFF",backgroundOpacity:20,fontfamily:"微软雅黑"},autostart:!0}).seek(t.startTime);n.onReady(function(e){n.setCurrentCaptions(t.show_caption)}),n.onError(function(e){e.message&&e.message.match("meta.json")?t.play_seg?(console.log("change to local video."),this.remove(),t.play_seg=!1,loadVideo(t)):console.log("play local error."):console.log("play segment error.")})}window.onload=function(){console.log("v0.0.2");var e=navigator.userAgent,t=new Array("Android","iPhone","SymbianOS","Windows Phone","iPad","iPod");is_mobile=!1;for(var n=0;n<t.length;n++)if(0<e.indexOf(t[n])){is_mobile=!0;break}if(config_xml=new ParseXML(coursePath+"/data/whatyPresentation.xml"),config_xml){var o=$(".copyright");o&&config_xml.copyright?o.text(config_xml.copyright):o.hide(),init_course()}else alert("课件结构错误")};